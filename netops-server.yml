---
- name: create the gcp disk, firewall rule, and vm instance
  hosts: localhost
  gather_facts: no

  vars_files:
    - vars/vars-netops.yml

  tasks:
    - import_tasks: tasks/gcp-vm.yml
    
    - name: check the vm instance state
      command: >
        gcloud compute instances describe {{ vm_name }}
        --zone={{ zone }}
        --format="value(status)"
      register: state
      changed_when: no

    - name: fail if the vm instance is stopped
      fail:
        msg: "The {{ vm_name }} instance may need to be started."
      when: state.stdout.find('RUNNING') == -1

    - name: populate ssh config files with host entry
      command: gcloud compute config-ssh --quiet
      changed_when: no

    - name: get the vm instance public ipv4 address
      command: >
        gcloud compute instances describe {{ vm_name }}
        --zone={{ zone }}
        --format="value(networkInterfaces[0].accessConfigs[0].natIP)"
      register: public_ip
      changed_when: no

    - name: wait for ssh connection to become available
      wait_for:
        host: "{{ public_ip.stdout }}"
        port: 22
        delay: 10
        timeout: 60

    - name: add host to gns3 group
      add_host:
        name: "{{ public_ip.stdout }}"
        group: vpnserver
      changed_when: no